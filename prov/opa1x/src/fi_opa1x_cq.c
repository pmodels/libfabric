/*
 * Copyright (C) 2016 by Argonne National Laboratory.
 *
 * This software is available to you under a choice of one of two
 * licenses.  You may choose to be licensed under the terms of the GNU
 * General Public License (GPL) Version 2, available from the file
 * COPYING in the main directory of this source tree, or the
 * BSD license below:
 *
 *     Redistribution and use in source and binary forms, with or
 *     without modification, are permitted provided that the following
 *     conditions are met:
 *
 *      - Redistributions of source code must retain the above
 *        copyright notice, this list of conditions and the following
 *        disclaimer.
 *
 *      - Redistributions in binary form must reproduce the above
 *        copyright notice, this list of conditions and the following
 *        disclaimer in the documentation and/or other materials
 *        provided with the distribution.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
 * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
 * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
#include <ofi.h>

#include "rdma/opa1x/fi_opa1x_domain.h"
#include "rdma/opa1x/fi_opa1x_endpoint.h"
#include "rdma/opa1x/fi_opa1x_eq.h"
#include "rdma/opa1x/fi_opa1x.h"

#include <ofi_enosys.h>
#include <stdlib.h>

#define FI_OPA1X_DEFAULT_CQ_DEPTH (8192)
#define FI_OPA1X_MAXIMUM_CQ_DEPTH (8192)


void fi_opa1x_cq_debug(struct fid_cq *cq, const int line) {

	char str[2048];
	char *s = str;
	size_t len = 2047;
	int n = 0;
	union fi_opa1x_context * context = NULL;;

	struct fi_opa1x_cq *opa1x_cq = (struct fi_opa1x_cq *)cq;


	n = snprintf(s, len, "%s():%d [%p] completed(%p,%p)", __func__, line, opa1x_cq, opa1x_cq->completed.head, opa1x_cq->completed.tail);
	s += n;
	len -= n;

	if (opa1x_cq->completed.head != NULL) {
		context = opa1x_cq->completed.head;
		n = snprintf(s, len, " = { %p", context); s += n; len -= n;

		context = context->next;
		while (context != NULL) {
			n = snprintf(s, len, ", %p", context); s += n; len += n;
			context = context->next;
		}
		n = snprintf(s, len, " }"); s += n; len -= n;
	}
	fprintf(stderr, "%s\n", str);

	n = 0; len = 2047; s = str; *s = 0;
	n = snprintf(s, len, "%s():%d [%p] pending(%p,%p)", __func__, line, opa1x_cq, opa1x_cq->pending.head, opa1x_cq->pending.tail); s += n; len -= n;
	if (opa1x_cq->pending.head != NULL) {
		context = opa1x_cq->pending.head;
		n = snprintf(s, len, " = { %p(%lu,0x%016lx)", context, context->byte_counter, context->byte_counter); s += n; len -= n;

		context = context->next;
		while (context != NULL) {
			n = snprintf(s, len, ", %p(%lu,0x%016lx)", context, context->byte_counter, context->byte_counter); s += n; len += n;
			context = context->next;
		}
		n = snprintf(s, len, " }"); s += n; len -= n;
	}

	fprintf(stderr, "%s\n", str);

	n = 0; len = 2047; s = str; *s = 0;
	n = snprintf(s, len, "%s():%d [%p] err(%p,%p)", __func__, line, opa1x_cq, opa1x_cq->err.head, opa1x_cq->err.tail); s += n; len -= n;
	if (opa1x_cq->err.head != NULL) {
		context = opa1x_cq->err.head;
		n = snprintf(s, len, " = { %p(%lu)", context, context->byte_counter); s += n; len -= n;

		context = context->next;
		while (context != NULL) {
			n = snprintf(s, len, ", %p(%lu)", context, context->byte_counter); s += n; len += n;
			context = context->next;
		}
		n = snprintf(s, len, " }"); s += n; len -= n;
	}

	fprintf(stderr, "%s\n", str);
}



static int fi_opa1x_close_cq(fid_t fid)
{
	FI_DBG_TRACE(fi_opa1x_global.prov, FI_LOG_CQ, "close cq\n");

	int ret;
	struct fi_opa1x_cq *opa1x_cq =
		container_of(fid, struct fi_opa1x_cq, cq_fid);

	ret = fi_opa1x_fid_check(fid, FI_CLASS_CQ, "completion queue");
	if (ret)
		return ret;

	ret = fi_opa1x_ref_dec(&opa1x_cq->domain->ref_cnt, "domain");
	if (ret)
		return ret;

	ret = fi_opa1x_ref_finalize(&opa1x_cq->ref_cnt, "completion queue");
	if (ret)
		return ret;

	free(opa1x_cq);

	FI_DBG_TRACE(fi_opa1x_global.prov, FI_LOG_CQ, "cq closed\n");
	return 0;
}

static int fi_opa1x_bind_cq(struct fid *fid, struct fid *bfid,
		uint64_t flags)
{
	FI_WARN(fi_opa1x_global.prov, FI_LOG_CQ, "unimplemented\n");
	errno = FI_ENOSYS;
	return -errno;
}

static int fi_opa1x_control_cq(fid_t fid, int command, void *arg)
{
	FI_WARN(fi_opa1x_global.prov, FI_LOG_CQ, "unimplemented\n");
	errno = FI_ENOSYS;
	return -errno;
}

static int fi_opa1x_ops_open_cq(struct fid *fid, const char *name,
		uint64_t flags, void **ops, void *context)
{
	FI_WARN(fi_opa1x_global.prov, FI_LOG_CQ, "unimplemented\n");
	errno = FI_ENOSYS;
	return -errno;
}

static struct fi_ops fi_opa1x_fi_ops = {
	.size		= sizeof(struct fi_ops),
	.close		= fi_opa1x_close_cq,
	.bind		= fi_opa1x_bind_cq,
	.control	= fi_opa1x_control_cq,
	.ops_open	= fi_opa1x_ops_open_cq
};

static ssize_t fi_opa1x_cq_read(struct fid_cq *cq, void *buf, size_t count)
{
	FI_DBG_TRACE(fi_opa1x_global.prov, FI_LOG_CQ, "(begin)\n");
	int lock_required;
	int ret;
	struct fi_opa1x_cq *opa1x_cq = container_of(cq, struct fi_opa1x_cq, cq_fid);

	switch (opa1x_cq->domain->threading) {
	case FI_THREAD_ENDPOINT:
	case FI_THREAD_DOMAIN:
		lock_required = 0;
		break;
	default:
		lock_required = 1;
		break;
	}

	switch (opa1x_cq->format) {
	case FI_CQ_FORMAT_CONTEXT:
		if (lock_required)
			ret = fi_opa1x_cq_read_generic(cq, buf, count, FI_CQ_FORMAT_CONTEXT, 1, 0, OFI_RELIABILITY_KIND_RUNTIME, FI_PROGRESS_MANUAL);
		else
			ret = fi_opa1x_cq_read_generic(cq, buf, count, FI_CQ_FORMAT_CONTEXT, 0, 0, OFI_RELIABILITY_KIND_RUNTIME, FI_PROGRESS_MANUAL);
		break;
	case FI_CQ_FORMAT_MSG:
		if (lock_required)
			ret = fi_opa1x_cq_read_generic(cq, buf, count, FI_CQ_FORMAT_MSG, 1, 0, OFI_RELIABILITY_KIND_RUNTIME, FI_PROGRESS_MANUAL);
		else
			ret = fi_opa1x_cq_read_generic(cq, buf, count, FI_CQ_FORMAT_MSG, 0, 0, OFI_RELIABILITY_KIND_RUNTIME, FI_PROGRESS_MANUAL);
		break;
	case FI_CQ_FORMAT_DATA:
		if (lock_required)
			ret = fi_opa1x_cq_read_generic(cq, buf, count, FI_CQ_FORMAT_DATA, 1, 0, OFI_RELIABILITY_KIND_RUNTIME, FI_PROGRESS_MANUAL);
		else
			ret = fi_opa1x_cq_read_generic(cq, buf, count, FI_CQ_FORMAT_DATA, 0, 0, OFI_RELIABILITY_KIND_RUNTIME, FI_PROGRESS_MANUAL);
		break;
	case FI_CQ_FORMAT_TAGGED:
		if (lock_required)
			ret = fi_opa1x_cq_read_generic(cq, buf, count, FI_CQ_FORMAT_TAGGED, 1, 0, OFI_RELIABILITY_KIND_RUNTIME, FI_PROGRESS_MANUAL);
		else
			ret = fi_opa1x_cq_read_generic(cq, buf, count, FI_CQ_FORMAT_TAGGED, 0, 0, OFI_RELIABILITY_KIND_RUNTIME, FI_PROGRESS_MANUAL);
		break;
	default:
		FI_WARN(fi_opa1x_global.prov, FI_LOG_CQ, "Unsupported CQ format (%u)\n", opa1x_cq->format);
		abort();
		break;
	}



	FI_DBG_TRACE(fi_opa1x_global.prov, FI_LOG_CQ, "(end)\n");
	return ret;
}

static ssize_t
fi_opa1x_cq_readfrom(struct fid_cq *cq, void *buf, size_t count, fi_addr_t *src_addr)
{
	FI_DBG_TRACE(fi_opa1x_global.prov, FI_LOG_CQ, "(begin)\n");
	int lock_required;
	int ret;
	struct fi_opa1x_cq *opa1x_cq = container_of(cq, struct fi_opa1x_cq, cq_fid);

	switch (opa1x_cq->domain->threading) {
	case FI_THREAD_ENDPOINT:
	case FI_THREAD_DOMAIN:
		lock_required = 0;
		break;
	default:
		lock_required = 1;
		break;
	}

	switch (opa1x_cq->format) {
	case FI_CQ_FORMAT_CONTEXT:
		if (lock_required)
			ret = fi_opa1x_cq_readfrom_generic(cq, buf, count, src_addr, FI_CQ_FORMAT_CONTEXT, 1, 0, OFI_RELIABILITY_KIND_RUNTIME, FI_PROGRESS_MANUAL);
		else
			ret = fi_opa1x_cq_readfrom_generic(cq, buf, count, src_addr, FI_CQ_FORMAT_CONTEXT, 0, 0, OFI_RELIABILITY_KIND_RUNTIME, FI_PROGRESS_MANUAL);
		break;
	case FI_CQ_FORMAT_MSG:
		if (lock_required)
			ret = fi_opa1x_cq_readfrom_generic(cq, buf, count, src_addr, FI_CQ_FORMAT_MSG, 1, 0, OFI_RELIABILITY_KIND_RUNTIME, FI_PROGRESS_MANUAL);
		else
			ret = fi_opa1x_cq_readfrom_generic(cq, buf, count, src_addr, FI_CQ_FORMAT_MSG, 0, 0, OFI_RELIABILITY_KIND_RUNTIME, FI_PROGRESS_MANUAL);
		break;
	case FI_CQ_FORMAT_DATA:
		if (lock_required)
			ret = fi_opa1x_cq_readfrom_generic(cq, buf, count, src_addr, FI_CQ_FORMAT_DATA, 1, 0, OFI_RELIABILITY_KIND_RUNTIME, FI_PROGRESS_MANUAL);
		else
			ret = fi_opa1x_cq_readfrom_generic(cq, buf, count, src_addr, FI_CQ_FORMAT_DATA, 0, 0, OFI_RELIABILITY_KIND_RUNTIME, FI_PROGRESS_MANUAL);
		break;
	case FI_CQ_FORMAT_TAGGED:
		if (lock_required)
			ret = fi_opa1x_cq_readfrom_generic(cq, buf, count, src_addr, FI_CQ_FORMAT_TAGGED, 1, 0, OFI_RELIABILITY_KIND_RUNTIME, FI_PROGRESS_MANUAL);
		else
			ret = fi_opa1x_cq_readfrom_generic(cq, buf, count, src_addr, FI_CQ_FORMAT_TAGGED, 0, 0, OFI_RELIABILITY_KIND_RUNTIME, FI_PROGRESS_MANUAL);
		break;
	default:
		FI_WARN(fi_opa1x_global.prov, FI_LOG_CQ, "Unsupported CQ format (%u)\n", opa1x_cq->format);
		abort();
		break;
	}

	FI_DBG_TRACE(fi_opa1x_global.prov, FI_LOG_CQ, "(end)\n");
	return ret;
}

static ssize_t
fi_opa1x_cq_readerr(struct fid_cq *cq, struct fi_cq_err_entry *buf, uint64_t flags)
{
	FI_DBG_TRACE(fi_opa1x_global.prov, FI_LOG_CQ, "(begin)\n");

	struct fi_opa1x_cq *opa1x_cq = container_of(cq, struct fi_opa1x_cq, cq_fid);

	if (IS_PROGRESS_MANUAL(opa1x_cq->domain)) {

		struct fi_opa1x_context_ext * ext =
			 (struct fi_opa1x_context_ext *) opa1x_cq->err.head;

		if ((ext == NULL) || (ext->opa1x_context.byte_counter != 0)) {
			/* perhaps an in-progress truncated rendezvous receive? */
			errno = FI_EAGAIN;
			return -errno;
		}

		assert(ext->opa1x_context.flags & FI_OPA1X_CQ_CONTEXT_EXT);	/* DEBUG */

		const enum fi_threading threading = opa1x_cq->domain->threading;

		switch (threading) {
		case FI_THREAD_ENDPOINT:
		case FI_THREAD_DOMAIN:
			*buf = ext->err_entry;
			slist_remove_head((struct slist *)&opa1x_cq->err);
			free(ext);
			break;
		default:
			FI_WARN(fi_opa1x_global.prov, FI_LOG_CQ, "bad thread mode (%u)\n", threading);
			abort();
			break;
		}

	} else {
		FI_WARN(fi_opa1x_global.prov, FI_LOG_CQ, "unimplemented\n");
		abort();
	}

	FI_DBG_TRACE(fi_opa1x_global.prov, FI_LOG_CQ, "(end)\n");
	return 1;
}

static ssize_t
fi_opa1x_cq_sread(struct fid_cq *cq, void *buf, size_t len, const void *cond, int timeout)
{
	FI_WARN(fi_opa1x_global.prov, FI_LOG_CQ, "unimplemented\n");
	abort();

	errno = FI_EAGAIN;
	return -errno;
}

static ssize_t
fi_opa1x_cq_sreadfrom(struct fid_cq *cq, void *buf, size_t len,
		   fi_addr_t *src_addr, const void *cond, int timeout)
{
	FI_WARN(fi_opa1x_global.prov, FI_LOG_CQ, "unimplemented\n");
	abort();

	errno = FI_EAGAIN;
	return -errno;
}

static const char *
fi_opa1x_cq_strerror(struct fid_cq *cq, int prov_errno, const void *err_data,
	       char *buf, size_t len)
{
	FI_WARN(fi_opa1x_global.prov, FI_LOG_CQ, "unimplemented\n");
	errno = FI_ENOSYS;
	return NULL;
}




int fi_opa1x_cq_enqueue_err (struct fi_opa1x_cq * opa1x_cq,
		struct fi_opa1x_context_ext * ext,
		const int lock_required)
{
	assert(ext->opa1x_context.flags & FI_OPA1X_CQ_CONTEXT_EXT);	/* DEBUG */
	ext->opa1x_context.next = NULL;

	const enum fi_threading threading = opa1x_cq->domain->threading;

	switch (threading) {
		case FI_THREAD_ENDPOINT:
		case FI_THREAD_DOMAIN:
			fi_opa1x_context_slist_insert_tail((union fi_opa1x_context *)ext, &opa1x_cq->err);
			break;
		default:
			fprintf(stderr, "%s:%s():%d\n", __FILE__, __func__, __LINE__); abort();
			break;
	}

	return 0;
}


/* CAPS = 0x0000000000000000ull (runtime) */
/* ---- OFI_RELIABILITY_KIND_NONE */
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_NONE, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 1, OFI_RELIABILITY_KIND_NONE, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_NONE, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 1, OFI_RELIABILITY_KIND_NONE, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_NONE, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 1, OFI_RELIABILITY_KIND_NONE, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_NONE, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 1, OFI_RELIABILITY_KIND_NONE, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_NONE, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 1, OFI_RELIABILITY_KIND_NONE, 0x0000000000000000ull, FI_PROGRESS_MANUAL)

/* ----- OFI_RELIABILITY_KIND_OFFLOAD */
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 1, OFI_RELIABILITY_KIND_OFFLOAD, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 1, OFI_RELIABILITY_KIND_OFFLOAD, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 1, OFI_RELIABILITY_KIND_OFFLOAD, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 1, OFI_RELIABILITY_KIND_OFFLOAD, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 1, OFI_RELIABILITY_KIND_OFFLOAD, 0x0000000000000000ull, FI_PROGRESS_MANUAL)

/* ----- OFI_RELIABILITY_KIND_ONLOAD */
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 1, OFI_RELIABILITY_KIND_ONLOAD, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 1, OFI_RELIABILITY_KIND_ONLOAD, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 1, OFI_RELIABILITY_KIND_ONLOAD, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 1, OFI_RELIABILITY_KIND_ONLOAD, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 1, OFI_RELIABILITY_KIND_ONLOAD, 0x0000000000000000ull, FI_PROGRESS_MANUAL)

/* ---- OFI_RELIABILITY_KIND_RUNTIME */
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 1, OFI_RELIABILITY_KIND_RUNTIME, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 1, OFI_RELIABILITY_KIND_RUNTIME, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 1, OFI_RELIABILITY_KIND_RUNTIME, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 1, OFI_RELIABILITY_KIND_RUNTIME, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0000000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 1, OFI_RELIABILITY_KIND_RUNTIME, 0x0000000000000000ull, FI_PROGRESS_MANUAL)


/* CAPS = 0x0008000000000000ull (only local) */
/* ---- OFI_RELIABILITY_KIND_NONE */
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_NONE, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 1, OFI_RELIABILITY_KIND_NONE, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_NONE, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 1, OFI_RELIABILITY_KIND_NONE, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_NONE, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 1, OFI_RELIABILITY_KIND_NONE, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_NONE, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 1, OFI_RELIABILITY_KIND_NONE, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_NONE, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 1, OFI_RELIABILITY_KIND_NONE, 0x0008000000000000ull, FI_PROGRESS_MANUAL)

/* ----- OFI_RELIABILITY_KIND_OFFLOAD */
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 1, OFI_RELIABILITY_KIND_OFFLOAD, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 1, OFI_RELIABILITY_KIND_OFFLOAD, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 1, OFI_RELIABILITY_KIND_OFFLOAD, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 1, OFI_RELIABILITY_KIND_OFFLOAD, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 1, OFI_RELIABILITY_KIND_OFFLOAD, 0x0008000000000000ull, FI_PROGRESS_MANUAL)

/* ----- OFI_RELIABILITY_KIND_ONLOAD */
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 1, OFI_RELIABILITY_KIND_ONLOAD, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 1, OFI_RELIABILITY_KIND_ONLOAD, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 1, OFI_RELIABILITY_KIND_ONLOAD, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 1, OFI_RELIABILITY_KIND_ONLOAD, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 1, OFI_RELIABILITY_KIND_ONLOAD, 0x0008000000000000ull, FI_PROGRESS_MANUAL)

/* ---- OFI_RELIABILITY_KIND_RUNTIME */
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 1, OFI_RELIABILITY_KIND_RUNTIME, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 1, OFI_RELIABILITY_KIND_RUNTIME, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 1, OFI_RELIABILITY_KIND_RUNTIME, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 1, OFI_RELIABILITY_KIND_RUNTIME, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0008000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 1, OFI_RELIABILITY_KIND_RUNTIME, 0x0008000000000000ull, FI_PROGRESS_MANUAL)


/* CAPS = 0x0010000000000000ull (only remote) */
/* ---- OFI_RELIABILITY_KIND_NONE */
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_NONE, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 1, OFI_RELIABILITY_KIND_NONE, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_NONE, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 1, OFI_RELIABILITY_KIND_NONE, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_NONE, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 1, OFI_RELIABILITY_KIND_NONE, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_NONE, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 1, OFI_RELIABILITY_KIND_NONE, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_NONE, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 1, OFI_RELIABILITY_KIND_NONE, 0x0010000000000000ull, FI_PROGRESS_MANUAL)

/* ----- OFI_RELIABILITY_KIND_OFFLOAD */
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 1, OFI_RELIABILITY_KIND_OFFLOAD, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 1, OFI_RELIABILITY_KIND_OFFLOAD, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 1, OFI_RELIABILITY_KIND_OFFLOAD, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 1, OFI_RELIABILITY_KIND_OFFLOAD, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 1, OFI_RELIABILITY_KIND_OFFLOAD, 0x0010000000000000ull, FI_PROGRESS_MANUAL)

/* ----- OFI_RELIABILITY_KIND_ONLOAD */
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 1, OFI_RELIABILITY_KIND_ONLOAD, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 1, OFI_RELIABILITY_KIND_ONLOAD, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 1, OFI_RELIABILITY_KIND_ONLOAD, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 1, OFI_RELIABILITY_KIND_ONLOAD, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 1, OFI_RELIABILITY_KIND_ONLOAD, 0x0010000000000000ull, FI_PROGRESS_MANUAL)

/* ---- OFI_RELIABILITY_KIND_RUNTIME */
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 1, OFI_RELIABILITY_KIND_RUNTIME, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 1, OFI_RELIABILITY_KIND_RUNTIME, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 1, OFI_RELIABILITY_KIND_RUNTIME, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 1, OFI_RELIABILITY_KIND_RUNTIME, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0010000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 1, OFI_RELIABILITY_KIND_RUNTIME, 0x0010000000000000ull, FI_PROGRESS_MANUAL)


/* CAPS = 0x0018000000000000ull (local and remote) */
/* ---- OFI_RELIABILITY_KIND_NONE */
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_NONE, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 1, OFI_RELIABILITY_KIND_NONE, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_NONE, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 1, OFI_RELIABILITY_KIND_NONE, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_NONE, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 1, OFI_RELIABILITY_KIND_NONE, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_NONE, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 1, OFI_RELIABILITY_KIND_NONE, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_NONE, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 1, OFI_RELIABILITY_KIND_NONE, 0x0018000000000000ull, FI_PROGRESS_MANUAL)

/* ----- OFI_RELIABILITY_KIND_OFFLOAD */
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 1, OFI_RELIABILITY_KIND_OFFLOAD, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 1, OFI_RELIABILITY_KIND_OFFLOAD, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 1, OFI_RELIABILITY_KIND_OFFLOAD, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 1, OFI_RELIABILITY_KIND_OFFLOAD, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 1, OFI_RELIABILITY_KIND_OFFLOAD, 0x0018000000000000ull, FI_PROGRESS_MANUAL)

/* ----- OFI_RELIABILITY_KIND_ONLOAD */
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 1, OFI_RELIABILITY_KIND_ONLOAD, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 1, OFI_RELIABILITY_KIND_ONLOAD, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 1, OFI_RELIABILITY_KIND_ONLOAD, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 1, OFI_RELIABILITY_KIND_ONLOAD, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 1, OFI_RELIABILITY_KIND_ONLOAD, 0x0018000000000000ull, FI_PROGRESS_MANUAL)

/* ---- OFI_RELIABILITY_KIND_RUNTIME */
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_UNSPEC, 1, OFI_RELIABILITY_KIND_RUNTIME, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_CONTEXT, 1, OFI_RELIABILITY_KIND_RUNTIME, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_MSG, 1, OFI_RELIABILITY_KIND_RUNTIME, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_DATA, 1, OFI_RELIABILITY_KIND_RUNTIME, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0018000000000000ull, FI_PROGRESS_MANUAL)
	FI_OPA1X_CQ_SPECIALIZED_FUNC(FI_CQ_FORMAT_TAGGED, 1, OFI_RELIABILITY_KIND_RUNTIME, 0x0018000000000000ull, FI_PROGRESS_MANUAL)


#define FI_OPA1X_CQ_OPS_STRUCT_NAME(FORMAT, LOCK, RELIABILITY, CAPS, PROGRESS)			\
  fi_opa1x_ops_cq_ ## FORMAT ## _ ## LOCK ## _ ## RELIABILITY ## _ ## CAPS ## _ ## PROGRESS			\

#define FI_OPA1X_CQ_OPS_STRUCT_INIT(FORMAT, LOCK, RELIABILITY, CAPS)			\
  {										\
    .size    = sizeof(struct fi_ops_cq),					\
    .read      = FI_OPA1X_CQ_SPECIALIZED_FUNC_NAME(cq_read, FORMAT, LOCK, RELIABILITY, CAPS, FI_PROGRESS_MANUAL),		\
    .readfrom  = FI_OPA1X_CQ_SPECIALIZED_FUNC_NAME(cq_readfrom, FORMAT, LOCK, RELIABILITY, CAPS, FI_PROGRESS_MANUAL),	\
    .readerr   = fi_opa1x_cq_readerr,						\
    .sread     = fi_opa1x_cq_sread,						\
    .sreadfrom = fi_opa1x_cq_sreadfrom,						\
    .signal    = fi_no_cq_signal,						\
    .strerror  = fi_opa1x_cq_strerror,						\
  }

#define FI_OPA1X_CQ_OPS_STRUCT(FORMAT, LOCK, RELIABILITY, CAPS, PROGRESS)				\
static struct fi_ops_cq								\
	FI_OPA1X_CQ_OPS_STRUCT_NAME(FORMAT, LOCK, RELIABILITY, CAPS, PROGRESS) = 			\
		FI_OPA1X_CQ_OPS_STRUCT_INIT(FORMAT, LOCK, RELIABILITY, CAPS, PROGRESS)


/* [lock][format][reliability][caps] */
static struct fi_ops_cq fi_opa1x_ops_cq_table[2*5*4*4] = {

	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_NONE, 0x0000000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_NONE, 0x0008000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_NONE, 0x0010000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_NONE, 0x0018000000000000ull),

	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0000000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0008000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0010000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0018000000000000ull),

	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0000000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0008000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0010000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0018000000000000ull),

	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0000000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0008000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0010000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_UNSPEC, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0018000000000000ull),


	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_NONE, 0x0000000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_NONE, 0x0008000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_NONE, 0x0010000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_NONE, 0x0018000000000000ull),

	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0000000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0008000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0010000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0018000000000000ull),

	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0000000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0008000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0010000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0018000000000000ull),

	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0000000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0008000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0010000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_CONTEXT, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0018000000000000ull),


	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_NONE, 0x0000000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_NONE, 0x0008000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_NONE, 0x0010000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_NONE, 0x0018000000000000ull),

	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0000000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0008000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0010000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0018000000000000ull),

	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0000000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0008000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0010000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0018000000000000ull),

	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0000000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0008000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0010000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_MSG, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0018000000000000ull),


	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_NONE, 0x0000000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_NONE, 0x0008000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_NONE, 0x0010000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_NONE, 0x0018000000000000ull),

	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0000000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0008000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0010000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0018000000000000ull),

	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0000000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0008000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0010000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0018000000000000ull),

	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0000000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0008000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0010000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_DATA, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0018000000000000ull),


	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_NONE, 0x0000000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_NONE, 0x0008000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_NONE, 0x0010000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_NONE, 0x0018000000000000ull),

	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0000000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0008000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0010000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_OFFLOAD, 0x0018000000000000ull),

	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0000000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0008000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0010000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_ONLOAD, 0x0018000000000000ull),

	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0000000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0008000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0010000000000000ull),
	FI_OPA1X_CQ_OPS_STRUCT_INIT(FI_CQ_FORMAT_TAGGED, 0, OFI_RELIABILITY_KIND_RUNTIME, 0x0018000000000000ull)
};


static struct fi_ops_cq fi_opa1x_ops_cq_default = {
	.size		= sizeof(struct fi_ops_cq),
	.read		= fi_opa1x_cq_read,
	.readfrom	= fi_opa1x_cq_readfrom,
	.readerr	= fi_opa1x_cq_readerr,
	.signal		= fi_no_cq_signal,
	.sread		= fi_opa1x_cq_sread,
	.sreadfrom	= fi_opa1x_cq_sreadfrom,
	.strerror	= fi_opa1x_cq_strerror
};


struct fi_ops_cq * fi_opa1x_cq_select_ops(const enum fi_cq_format format,
		const enum fi_threading threading,
		const enum ofi_reliability_kind reliability,
		const uint64_t caps,
		const enum fi_progress progress)
{
	if (progress != FI_PROGRESS_MANUAL) {
		FI_WARN(fi_opa1x_global.prov, FI_LOG_CQ, "only FI_PROGRESS_MANUAL is supported (%u).\n", progress);
		abort();
	}

	struct fi_ops_cq *ops = &fi_opa1x_ops_cq_default;

	typedef struct fi_ops_cq op_matrix_t[2][5][4][4];
	op_matrix_t *ops_matrix = (op_matrix_t *)&fi_opa1x_ops_cq_table;

	const uint64_t comm_caps = (caps & (FI_LOCAL_COMM | FI_REMOTE_COMM)) >> 51;
//fprintf(stderr, "%s:%s():%d caps = 0x%016lx, comm_caps = 0x%016lx\n", __FILE__, __func__, __LINE__, caps, comm_caps);

	switch (threading) {
	case FI_THREAD_ENDPOINT:
	case FI_THREAD_DOMAIN:
	case FI_THREAD_COMPLETION:
		ops = &(*ops_matrix)[0][format][reliability][comm_caps];
//fprintf(stderr, "%s:%s():%d lock_required = 0, format = %u, reliability = %u\n", __FILE__, __func__, __LINE__, format, reliability);
		break;
	case FI_THREAD_FID:
	case FI_THREAD_UNSPEC:
	case FI_THREAD_SAFE:
		ops = &(*ops_matrix)[1][format][reliability][comm_caps];
//fprintf(stderr, "%s:%s():%d lock_required = 1, format = %u, reliability = %u\n", __FILE__, __func__, __LINE__, format, reliability);
		break;
	default:
		abort();
		break;
	}

	return ops;
}




int fi_opa1x_cq_open(struct fid_domain *dom,
		struct fi_cq_attr *attr,
		struct fid_cq **cq, void *context)
{
	FI_DBG_TRACE(fi_opa1x_global.prov, FI_LOG_CQ, "open cq\n");

	int ret;
	struct fi_opa1x_cq *opa1x_cq;

	if (!attr) {
		FI_LOG(fi_opa1x_global.prov, FI_LOG_DEBUG, FI_LOG_CQ,
				"no attr supplied\n");
		errno = FI_EINVAL;
		return -errno;
	}
	ret = fi_opa1x_fid_check(&dom->fid, FI_CLASS_DOMAIN, "domain");
	if (ret)
		return ret;

	opa1x_cq = calloc(1, sizeof(*opa1x_cq));
	if (!opa1x_cq) {
		errno = FI_ENOMEM;
		goto err;
	}

	opa1x_cq->cq_fid.fid.fclass = FI_CLASS_CQ;
	opa1x_cq->cq_fid.fid.context= context;
	opa1x_cq->cq_fid.fid.ops    = &fi_opa1x_fi_ops;

	opa1x_cq->size = attr->size ? attr->size : FI_OPA1X_DEFAULT_CQ_DEPTH;

	opa1x_cq->domain = (struct fi_opa1x_domain *) dom;

	opa1x_cq->format = attr->format ? attr->format : FI_CQ_FORMAT_CONTEXT;

	fi_opa1x_context_slist_init(&opa1x_cq->pending);
	fi_opa1x_context_slist_init(&opa1x_cq->completed);
	fi_opa1x_context_slist_init(&opa1x_cq->err);

	opa1x_cq->cq_fid.ops =
		fi_opa1x_cq_select_ops(opa1x_cq->format,
			opa1x_cq->domain->threading,
			OFI_RELIABILITY_KIND_RUNTIME,
			0,
			opa1x_cq->domain->data_progress);

	opa1x_cq->ep_reliability = OFI_RELIABILITY_KIND_UNSET;
	opa1x_cq->ep_bind_count = 0;
	opa1x_cq->progress.ep_count = 0;
	unsigned i;
	for (i=0; i<64; ++i) {		/* TODO - check this array size */
		opa1x_cq->ep[i] = NULL;
		opa1x_cq->progress.ep[i] = NULL;
	}


	//fi_opa1x_ref_init(&opa1x_cq->domain->fabric->node, &opa1x_cq->ref_cnt, "completion queue");
	fi_opa1x_ref_inc(&opa1x_cq->domain->ref_cnt, "domain");

	*cq = &opa1x_cq->cq_fid;

	FI_DBG_TRACE(fi_opa1x_global.prov, FI_LOG_CQ, "cq opened\n");
	return 0;
err:
	if(opa1x_cq)
		free(opa1x_cq);
	return -errno;
}

int fi_opa1x_bind_ep_cq(struct fid_ep *ep,
		struct fid_cq *cq, uint64_t flags)
{
	FI_DBG_TRACE(fi_opa1x_global.prov, FI_LOG_CQ, "(begin)\n");

	struct fi_opa1x_ep *opa1x_ep =
		container_of(ep, struct fi_opa1x_ep, ep_fid);

	struct fi_opa1x_cq *opa1x_cq =
		container_of(cq, struct fi_opa1x_cq, cq_fid);
	if (!(flags & (FI_TRANSMIT | FI_RECV)))
		goto err;

	const enum ofi_reliability_kind reliability = opa1x_ep->reliability_state.kind;

	if (flags & FI_TRANSMIT) {
		fi_opa1x_ref_inc(&opa1x_cq->ref_cnt, "tx completion queue");
		opa1x_ep->tx.cq = opa1x_cq;
		opa1x_ep->tx.cq_completed_ptr = &opa1x_cq->completed;
		opa1x_ep->tx.cq_pending_ptr = &opa1x_cq->pending;
		opa1x_ep->tx.cq_err_ptr = &opa1x_cq->err;
		//opa1x_ep->tx.cq_lock_ptr = &opa1x_cq->lock;

		/* See NOTE_SELECTIVE_COMPLETION for more information */
		opa1x_ep->tx.cq_bind_flags = flags;

		const uint64_t selective_completion =
			FI_SELECTIVE_COMPLETION | FI_TRANSMIT | FI_COMPLETION;

		const uint64_t cq_flags = opa1x_ep->tx.op_flags | flags;

		opa1x_ep->tx.do_cq_completion =
			((cq_flags & selective_completion) == selective_completion) ||
			((cq_flags & (FI_SELECTIVE_COMPLETION | FI_TRANSMIT)) == FI_TRANSMIT);

	}
	if (flags & FI_RECV) {
		fi_opa1x_ref_inc(&opa1x_cq->ref_cnt, "rx completion queue");
		opa1x_ep->rx.cq = opa1x_cq;
		opa1x_ep->rx.cq_completed_ptr = &opa1x_cq->completed;
		opa1x_ep->rx.cq_pending_ptr = &opa1x_cq->pending;
		opa1x_ep->rx.cq_err_ptr = &opa1x_cq->err;
		//opa1x_ep->rx.cq_lock_ptr = &opa1x_cq->lock;
	}
	opa1x_cq->bflags = flags;

	if (FI_CLASS_RX_CTX == opa1x_ep->ep_fid.fid.fclass ||
			FI_CLASS_EP == opa1x_ep->ep_fid.fid.fclass) {
		opa1x_cq->ep[(opa1x_cq->ep_bind_count)++] = opa1x_ep;
	}

	if (ofi_recv_allowed(opa1x_ep->rx.caps) || ofi_rma_target_allowed(opa1x_ep->rx.caps)) {

		if (opa1x_cq->progress.ep_count == 0) {
			opa1x_cq->ep_reliability = opa1x_ep->reliability_state.kind;
			opa1x_cq->ep_comm_caps = opa1x_ep->rx.caps & (FI_LOCAL_COMM | FI_REMOTE_COMM);
		} else {
			if (opa1x_cq->ep_reliability != reliability) {
				opa1x_cq->ep_reliability = OFI_RELIABILITY_KIND_RUNTIME;
			}

			if (opa1x_cq->ep_comm_caps != (opa1x_ep->rx.caps & (FI_LOCAL_COMM | FI_REMOTE_COMM))) {
				opa1x_cq->ep_comm_caps = 0;
			}
		}

		opa1x_cq->cq_fid.ops =
			fi_opa1x_cq_select_ops(opa1x_cq->format,
				opa1x_cq->domain->threading,
				opa1x_cq->ep_reliability,
				opa1x_cq->ep_comm_caps,
				opa1x_cq->domain->data_progress);

		opa1x_cq->progress.ep[(opa1x_cq->progress.ep_count)++] = opa1x_ep;
	}

	FI_DBG_TRACE(fi_opa1x_global.prov, FI_LOG_CQ, "(end)\n");
	return 0;
err:
	FI_DBG_TRACE(fi_opa1x_global.prov, FI_LOG_CQ, "(end, error)\n");
	errno = FI_EINVAL;
	return -errno;
}



#define FABRIC_DIRECT_LOCK		0
#define FABRIC_DIRECT_CQ_FORMAT		FI_CQ_FORMAT_TAGGED
#define FABRIC_DIRECT_RELIABILITY	OFI_RELIABILITY_KIND_ONLOAD
#define FABRIC_DIRECT_CAPS		0x0000000000000000ull

ssize_t
fi_opa1x_cq_read_FABRIC_DIRECT(struct fid_cq *cq, void *buf, size_t count)
{
	return FI_OPA1X_CQ_SPECIALIZED_FUNC_NAME(cq_read,
			FABRIC_DIRECT_CQ_FORMAT,
			FABRIC_DIRECT_LOCK,
			FABRIC_DIRECT_RELIABILITY,
			FABRIC_DIRECT_CAPS,
			FABRIC_DIRECT_PROGRESS)
				(cq, buf, count);
}

ssize_t
fi_opa1x_cq_readfrom_FABRIC_DIRECT(struct fid_cq *cq, void *buf, size_t count,
		fi_addr_t *src_addr)
{
	return FI_OPA1X_CQ_SPECIALIZED_FUNC_NAME(cq_readfrom,
			FABRIC_DIRECT_CQ_FORMAT,
			FABRIC_DIRECT_LOCK,
			FABRIC_DIRECT_RELIABILITY,
			FABRIC_DIRECT_CAPS,
			FABRIC_DIRECT_PROGRESS)
				(cq, buf, count, src_addr);
}
